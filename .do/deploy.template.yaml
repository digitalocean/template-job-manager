# This is used to mark this repo as containing a sample.

spec:
  name: template-job-manager

  databases:
    - engine: PG
      name: db-task-service
    - engine: PG
      name: db-leases
  ingress:
    rules:
      - component:
          name: leases
        match:
          path:
            prefix: /leases
      - component:
          name: task-service
        match:
          path:
            prefix: /
  jobs:
    - name: migrations-task-service
      environment_slug: node-js
      envs:
        - key: DATABASE_URL
          scope: RUN_TIME
          value: ${db-task-service.DATABASE_URL}
      git:
        branch: main
        repo_clone_url: https://github.com/digitalocean/template-job-manager.git
      source_dir: task-service
      run_command: npx prisma migrate deploy

    - name: migrations-leases
      environment_slug: node-js
      envs:
        - key: DATABASE_URL
          scope: RUN_TIME
          value: ${db-leases.DATABASE_URL}
      git:
        branch: main
        repo_clone_url: https://github.com/digitalocean/template-job-manager.git
      source_dir: leases
      run_command: npx prisma migrate deploy

  services:
    - environment_slug: node-js
      envs:
        - key: DATABASE_URL
          scope: RUN_TIME
          value: ${db-task-service.DATABASE_URL}
        - key: NEXT_PUBLIC_URL
          scope: RUN_AND_BUILD_TIME
          value: https://demo-job-manager-mhyct.ondigitalocean.app
        - key: SERVICE_LEASES_URL
          scope: RUN_AND_BUILD_TIME
          value: http://leases:8080/api/leases
      git:
        branch: main
        repo_clone_url: https://github.com/digitalocean/template-job-manager.git
      source_dir: task-service
      name: task-service
      build_command: npm install && npm run build
      run_command: npm start

    - environment_slug: node-js
      envs:
        - key: DATABASE_URL
          scope: RUN_TIME
          value: ${db-leases.DATABASE_URL}
        - key: NEXT_PUBLIC_URL
          scope: RUN_AND_BUILD_TIME
          value: https://demo-job-manager-mhyct.ondigitalocean.app/leases
      git:
        branch: main
        repo_clone_url: https://github.com/digitalocean/template-job-manager.git
      source_dir: leases
      name: leases
      build_command: npm install && npm run build
      run_command: npm start

  workers:
    - name: task-worker
      environment_slug: node-js
      git:
        branch: main
        repo_clone_url: https://github.com/digitalocean/template-job-manager.git
      source_dir: task-worker
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-1gb
      build_command: npm install
      envs:
        - key: TASK_SERVICE_URL
          value: https://demo-job-manager-mhyct.ondigitalocean.app
      run_command: node ./main.js
